<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Basket | Badal Bakery</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Tangerine:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary-pink: #ff0381;
            --bg-cream: #fcedec;
            --whatsapp-green: #25D366;
        }

        body {
            background-color: var(--bg-cream);
            font-family: "DM Sans", sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-family: "Tangerine", cursive;
            font-size: 4rem;
            color: var(--primary-pink);
            margin: 10px 0;
        }

        .cart-container {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #ffdae9;
            box-sizing: border-box;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #fce4ec;
        }

        .cart-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 12px;
        }

        .item-details {
            flex-grow: 1;
            margin-left: 15px;
        }

        .item-details h3 { margin: 0; font-size: 1rem; }
        .item-details p { margin: 4px 0 0; color: #666; }

        .remove-btn {
            background: none;
            border: none;
            color: #ff4d4d;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Map Styles */
        #map { 
            height: 250px; 
            width: 100%; 
            border-radius: 15px; 
            margin: 20px 0 10px 0; 
            border: 2px solid #ffdae9;
        }

        input#address { 
            width: 100%; 
            padding: 12px; 
            box-sizing: border-box; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
            background: #f9f9f9;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.4rem;
            font-weight: bold;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid var(--primary-pink);
        }

        .whatsapp-btn {
            width: 100%;
            background-color: var(--whatsapp-green);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .whatsapp-btn:hover { background-color: #128C7E; }
    </style>
</head>
<body>

    <h1>Your Basket</h1>

    <div class="cart-container">
        <div id="cart-content"></div>

        <div class="total-row">
            <span>Total:</span>
            <span>‚Çπ<span id="final-amount">0</span></span>
        </div>

        <h3 style="margin-top:25px; color: var(--primary-pink);">Set Delivery Location</h3>
        <div id="map"></div>
        <input type="text" id="address" placeholder="Tap the map to set address..." readonly>
        
        <button class="whatsapp-btn" onclick="sendWhatsAppOrder()">
            Confirm Order via WhatsApp
        </button>

        <p style="font-size: 0.75rem; color: #777; text-align: center; margin-top: 10px;">
            This will send your item list and location in one message.
        </p>
    </div>

    <a href="index.html" style="margin-top:20px; color:var(--primary-pink); text-decoration:none; font-weight:bold;">‚Üê Back to Menu</a>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let selectedLat = null;
        let selectedLng = null;

        // 1. Load items from LocalStorage
        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('bakeryCart')) || [];
            const container = document.getElementById('cart-content');
            const totalDisplay = document.getElementById('final-amount');
            let total = 0;

            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999;">Basket is empty!</p>';
                totalDisplay.innerText = "0";
                return;
            }

            container.innerHTML = '';
            cart.forEach((item, index) => {
                total += item.price;
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.image || 'https://via.placeholder.com/60'}" alt="${item.name}">
                        <div class="item-details">
                            <h3>${item.name}</h3>
                            <p>‚Çπ${item.price}</p>
                        </div>
                        <button class="remove-btn" onclick="removeItem(${index})">‚úï</button>
                    </div>
                `;
            });
            totalDisplay.innerText = total;
        }

        function removeItem(index) {
            let cart = JSON.parse(localStorage.getItem('bakeryCart')) || [];
            cart.splice(index, 1);
            localStorage.setItem('bakeryCart', JSON.stringify(cart));
            loadCart();
        }

        // 2. Initialize Map (Centered on Mussoorie/Landour based on your context)
        const map = L.map('map').setView([30.4599, 78.0934], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        let marker;
        map.on('click', function(e) {
            selectedLat = e.latlng.lat;
            selectedLng = e.latlng.lng;

            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }

            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${selectedLat}&lon=${selectedLng}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('address').value = data.display_name || "Location Selected";
                });
        });

        // 3. Unified WhatsApp Order Function
        function sendWhatsAppOrder() {
            const cart = JSON.parse(localStorage.getItem('bakeryCart')) || [];
            const address = document.getElementById('address').value;
            const total = document.getElementById('final-amount').innerText;

            if (cart.length === 0) return alert("Your basket is empty!");
            if (!selectedLat) return alert("Please select your delivery location on the map!");

            const phoneNumber = "917983427187";
            
            // Build Message
            let message = `*üßÅ NEW ORDER: BADAL BAKERY*\n`;
            message += `------------------------------\n`;
            
            cart.forEach((item, index) => {
                message += `${index + 1}. *${item.name}* - ‚Çπ${item.price}\n`;
            });

            message += `------------------------------\n`;
            message += `*Total Amount: ‚Çπ${total}*\n\n`;
            message += `*üìç Delivery Address:*\n${address}\n\n`;
            
            // Generate Google Maps Link
            const mapsLink = `https://www.google.com/maps?q=${selectedLat},${selectedLng}`;
            message += `*üó∫Ô∏è Google Maps Location:*\n${mapsLink}\n\n`;
            message += `Please confirm my order!`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            // Optional: localStorage.removeItem('bakeryCart'); // Uncomment if you want to clear cart after sending
            window.location.href = whatsappUrl;
        }

        window.onload = loadCart;
    </script>
</body>
</html>
